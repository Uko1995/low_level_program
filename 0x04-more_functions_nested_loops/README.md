more functions and mre nested loops

